name: Continuous Deployment to GKE

on:
  push:
    branches:
      - main
      - week6
  pull_request:
    branches:
      - main
      - week6

env:
  PROJECT_ID: week-1-474208
  GKE_CLUSTER: iris-mlops-cluster
  GKE_ZONE: us-central1-c
  IMAGE_NAME: iris-fastapi-api
  GAR_LOCATION: us-central1
  GAR_REPO: mlops-repository

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Continuous Integration & Reporting
  # ------------------------------------------------------------------
  ci-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          pip install -r requirements.txt

      - name: Set Google Cloud Credentials
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: DVC Pull Data
        run: |
          dvc remote add -d gcs_bucket gs://week-2-mlops-bucket/dvc_remote --force
          dvc config core.no_scm true
          dvc pull data/V3_augmented.csv.dvc --force

      - name: Run Pytest Validation and Evaluation Tests
        run: pytest tests/test_pipeline.py

      - name: Setup CML ðŸ› ï¸
        uses: iterative/setup-cml@v2

      - name: Create CML Sanity Report
        if: github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## CI Pipeline Status: PASSED âœ…" > report.md
          echo "CI tests passed. Deployment eligible upon merge." >> report.md
          cml comment create report.md

  # ------------------------------------------------------------------
  # JOB 2: Continuous Deployment (Build, Push, Deploy to GKE)
  # ------------------------------------------------------------------
  build-and-deploy:
    if: github.event_name == 'push' && success()
    runs-on: ubuntu-latest
    needs: [ci-tests]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # âœ… Define IMAGE_URL dynamically
      - name: Set IMAGE_URL
        run: |
          echo "IMAGE_URL=${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}" >> $GITHUB_ENV

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${GAR_LOCATION}-docker.pkg.dev --quiet

      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ${IMAGE_URL}:${IMAGE_TAG} .
          docker push ${IMAGE_URL}:${IMAGE_TAG}

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Deploy to GKE (Using Standard Shell)
        run: |
         IMAGE_TAG=${{ github.sha }}
         IMAGE_PATH=${{ env.IMAGE_URL }}:${IMAGE_TAG}

         

         echo "Deploying image: ${IMAGE_PATH} to GKE..."
         # Create deployment if not exists
         kubectl apply -f deployment.yaml

          # Update image in existing deployment
         kubectl set image deployment/iris-api-deployment iris-api=${IMAGE_PATH}
         kubectl rollout status deployment/iris-api-deployment --timeout=5m
# .github/workflows/ci.yml
# .github/workflows/ci.yml
name: IRIS DVC MLOps CI

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev # Run CI on PRs to both branches

jobs:
  test_and_report:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write   # Allows CML to write to the repository (if generating images/metrics)
      pull-requests: write # Allows CML to post comments/reports on PRs
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ----------------------------------------------------
      # 1. SETUP CORE ENVIRONMENT
      # ----------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Install Python dependencies (excluding CML, which is installed by the next action)
      - name: Install dependencies (DVC, Pytest)
        run: |
          sudo apt-get update
          pip install -r requirements.txt
          
      - name: Set MLflow Tracking URI and Authenticate
          env:
            # Use a secret for the remote server address
            MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
            # If MLflow needs auth (e.g., using Databricks), include relevant tokens here
          run: |
            # MLflow automatically uses the tracking URI set in the environment
            # Note: MLflow's default tracking URI is set by the env var.
            echo "MLflow tracking set up."

     - name: Run Pytest Validation and Evaluation Tests
          # The tests/test_pipeline.py script automatically loads the model 
          # via the MLFLOW_MODEL_URI
          run: pytest tests/test_pipeline.py

      # ----------------------------------------------------
      # 4. CML SETUP AND REPORTING
      # ----------------------------------------------------
      - name: Setup CML ðŸ› ï¸
        uses: iterative/setup-cml@v2
        
      - name: Create CML Sanity Report
        if: github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## CI/CD Pipeline Status Report ðŸ¤–" > report.md
          echo "" >> report.md
          echo "### Data and Model DVC Status" >> report.md
          echo "- **Data Version:** \`data/V3_augmented.csv\` (Pulled from GCS)" >> report.md
          echo "- **Model Version:** Latest version in \`artifacts/\`" >> report.md
          echo "" >> report.md
          echo "### Test Results (pytest)" >> report.md
          # NOTE: These results are hardcoded. In a real pipeline, you would parse the pytest output here.
          echo "- **Data Validation:** âœ… Passed" >> report.md
          echo "- **Model Sanity Check:** âœ… Passed" >> report.md
          echo "" >> report.md
          echo "CI pipeline successfully fetched artifacts from DVC and passed all tests on commit \`${{ github.sha }}\`." >> report.md
          
          # Use the CML command to post the report as a comment on the Pull Request
          cml comment create report.md
